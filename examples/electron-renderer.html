<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Electron-Safe Mac Recorder</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
					sans-serif;
				margin: 0;
				padding: 20px;
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				min-height: 100vh;
			}

			.container {
				max-width: 1000px;
				margin: 0 auto;
				background: rgba(255, 255, 255, 0.1);
				backdrop-filter: blur(10px);
				border-radius: 20px;
				padding: 30px;
				box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
			}

			h1 {
				text-align: center;
				margin-bottom: 30px;
				font-size: 2.5em;
				text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
			}

			.status-bar {
				background: rgba(255, 255, 255, 0.2);
				padding: 15px;
				border-radius: 10px;
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.recording-controls {
				display: flex;
				gap: 15px;
				margin-bottom: 30px;
				flex-wrap: wrap;
			}

			.btn {
				padding: 12px 24px;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-size: 16px;
				font-weight: 600;
				transition: all 0.3s ease;
				backdrop-filter: blur(10px);
			}

			.btn-primary {
				background: rgba(76, 175, 80, 0.8);
				color: white;
			}

			.btn-danger {
				background: rgba(244, 67, 54, 0.8);
				color: white;
			}

			.btn-secondary {
				background: rgba(255, 255, 255, 0.2);
				color: white;
			}

			.btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
			}

			.btn:disabled {
				opacity: 0.5;
				cursor: not-allowed;
				transform: none;
			}

			.options-panel {
				background: rgba(255, 255, 255, 0.1);
				padding: 20px;
				border-radius: 10px;
				margin-bottom: 20px;
			}

			.form-group {
				margin-bottom: 15px;
			}

			label {
				display: block;
				margin-bottom: 5px;
				font-weight: 600;
			}

			input[type="checkbox"] {
				margin-right: 8px;
				transform: scale(1.2);
			}

			select {
				width: 100%;
				padding: 8px;
				border-radius: 5px;
				border: none;
				background: rgba(255, 255, 255, 0.9);
				color: #333;
			}

			.displays-grid,
			.windows-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
				gap: 15px;
				margin-top: 15px;
			}

			.display-item,
			.window-item {
				background: rgba(255, 255, 255, 0.1);
				padding: 15px;
				border-radius: 10px;
				cursor: pointer;
				transition: all 0.3s ease;
				border: 2px solid transparent;
			}

			.display-item:hover,
			.window-item:hover {
				background: rgba(255, 255, 255, 0.2);
				transform: translateY(-2px);
			}

			.display-item.selected,
			.window-item.selected {
				border-color: #4caf50;
				background: rgba(76, 175, 80, 0.2);
			}

			.thumbnail {
				width: 100%;
				height: 120px;
				object-fit: cover;
				border-radius: 5px;
				margin-bottom: 10px;
				background: rgba(255, 255, 255, 0.1);
			}

			.info-section {
				background: rgba(255, 255, 255, 0.1);
				padding: 20px;
				border-radius: 10px;
				margin-bottom: 20px;
			}

			.permission-item {
				display: flex;
				justify-content: space-between;
				margin-bottom: 10px;
			}

			.status-indicator {
				padding: 4px 12px;
				border-radius: 15px;
				font-size: 12px;
				font-weight: 600;
			}

			.status-granted {
				background: rgba(76, 175, 80, 0.8);
			}

			.status-denied {
				background: rgba(244, 67, 54, 0.8);
			}

			.log-area {
				background: rgba(0, 0, 0, 0.3);
				padding: 15px;
				border-radius: 10px;
				height: 200px;
				overflow-y: auto;
				font-family: "Monaco", "Consolas", monospace;
				font-size: 12px;
				line-height: 1.4;
			}

			.recording-time {
				font-size: 1.5em;
				font-weight: bold;
				color: #ff4444;
				text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
			}

			.sections {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 20px;
			}

			@media (max-width: 768px) {
				.sections {
					grid-template-columns: 1fr;
				}

				.recording-controls {
					justify-content: center;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>üé¨ Electron-Safe Mac Recorder</h1>

			<div class="status-bar">
				<div>
					<strong>Status:</strong> <span id="recordingStatus">Idle</span>
				</div>
				<div class="recording-time" id="recordingTime">00:00</div>
			</div>

			<div class="recording-controls">
				<button id="startBtn" class="btn btn-primary">
					üé¨ Start Recording
				</button>
				<button id="stopBtn" class="btn btn-danger" disabled>
					üõë Stop Recording
				</button>
				<button id="refreshBtn" class="btn btn-secondary">üîÑ Refresh</button>
				<button id="permissionsBtn" class="btn btn-secondary">
					üîê Check Permissions
				</button>
			</div>

			<div class="options-panel">
				<h3>üìã Recording Options</h3>
				<div class="form-group">
					<label>
						<input type="checkbox" id="captureCursor" /> Capture Cursor
					</label>
				</div>
				<div class="form-group">
					<label>
						<input type="checkbox" id="includeMicrophone" /> Include Microphone
					</label>
				</div>
				<div class="form-group">
					<label>
						<input type="checkbox" id="includeSystemAudio" /> Include System
						Audio
					</label>
				</div>
			</div>

			<div class="sections">
				<div>
					<div class="info-section">
						<h3>üì∫ Displays</h3>
						<div class="displays-grid" id="displaysGrid">
							<div>Loading displays...</div>
						</div>
					</div>

					<div class="info-section">
						<h3>üîê Permissions</h3>
						<div id="permissionsInfo">
							<div>Checking permissions...</div>
						</div>
					</div>
				</div>

				<div>
					<div class="info-section">
						<h3>ü™ü Windows</h3>
						<div class="windows-grid" id="windowsGrid">
							<div>Loading windows...</div>
						</div>
					</div>

					<div class="info-section">
						<h3>üìú Activity Log</h3>
						<div class="log-area" id="logArea"></div>
					</div>
				</div>
			</div>
		</div>

		<script>
			// Application state
			let selectedDisplayId = null;
			let selectedWindowId = null;
			let isRecording = false;
			let recordingStartTime = 0;
			let timerInterval = null;

			// UI Elements
			const startBtn = document.getElementById("startBtn");
			const stopBtn = document.getElementById("stopBtn");
			const refreshBtn = document.getElementById("refreshBtn");
			const permissionsBtn = document.getElementById("permissionsBtn");
			const recordingStatus = document.getElementById("recordingStatus");
			const recordingTime = document.getElementById("recordingTime");
			const logArea = document.getElementById("logArea");
			const displaysGrid = document.getElementById("displaysGrid");
			const windowsGrid = document.getElementById("windowsGrid");
			const permissionsInfo = document.getElementById("permissionsInfo");

			// Logging function
			function log(message, type = "info") {
				const timestamp = new Date().toLocaleTimeString();
				const logEntry = `[${timestamp}] ${message}\n`;
				logArea.textContent += logEntry;
				logArea.scrollTop = logArea.scrollHeight;
				console.log(message);
			}

			// Format time as MM:SS
			function formatTime(seconds) {
				const mins = Math.floor(seconds / 60);
				const secs = seconds % 60;
				return `${mins.toString().padStart(2, "0")}:${secs
					.toString()
					.padStart(2, "0")}`;
			}

			// Update recording timer
			function updateTimer() {
				if (isRecording) {
					const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
					recordingTime.textContent = formatTime(elapsed);
				}
			}

			// Event Listeners Setup
			window.electronAPI.recorder.onRecordingStarted((event, data) => {
				log("üé¨ Recording started successfully");
				isRecording = true;
				recordingStartTime = Date.now();
				recordingStatus.textContent = "Recording";
				startBtn.disabled = true;
				stopBtn.disabled = false;

				timerInterval = setInterval(updateTimer, 1000);
			});

			window.electronAPI.recorder.onRecordingStopped((event, result) => {
				log("üõë Recording stopped");
				isRecording = false;
				recordingStatus.textContent = "Stopped";
				startBtn.disabled = false;
				stopBtn.disabled = true;

				if (timerInterval) {
					clearInterval(timerInterval);
					timerInterval = null;
				}
			});

			window.electronAPI.recorder.onRecordingCompleted((event, outputPath) => {
				log(`‚úÖ Recording completed: ${outputPath}`);
				recordingStatus.textContent = "Completed";
				recordingTime.textContent = "00:00";
			});

			window.electronAPI.recorder.onTimeUpdate((event, elapsed) => {
				recordingTime.textContent = formatTime(elapsed);
			});

			// Button Event Handlers
			startBtn.addEventListener("click", async () => {
				try {
					const saveDialog = await window.electronAPI.dialog.showSaveDialog();
					if (saveDialog.canceled) {
						return;
					}

					const options = {
						captureCursor: document.getElementById("captureCursor").checked,
						includeMicrophone:
							document.getElementById("includeMicrophone").checked,
						includeSystemAudio:
							document.getElementById("includeSystemAudio").checked,
						displayId: selectedDisplayId,
						windowId: selectedWindowId,
					};

					log(`üé¨ Starting recording with options: ${JSON.stringify(options)}`);
					const result = await window.electronAPI.recorder.startRecording(
						saveDialog.filePath,
						options
					);

					if (!result.success) {
						log(`‚ùå Failed to start recording: ${result.error}`, "error");
					}
				} catch (error) {
					log(`‚ùå Error starting recording: ${error.message}`, "error");
				}
			});

			stopBtn.addEventListener("click", async () => {
				try {
					log("üõë Stopping recording...");
					const result = await window.electronAPI.recorder.stopRecording();

					if (!result.success) {
						log(`‚ùå Failed to stop recording: ${result.error}`, "error");
					}
				} catch (error) {
					log(`‚ùå Error stopping recording: ${error.message}`, "error");
				}
			});

			refreshBtn.addEventListener("click", () => {
				log("üîÑ Refreshing...");
				loadDisplays();
				loadWindows();
				checkPermissions();
			});

			permissionsBtn.addEventListener("click", checkPermissions);

			// Load displays
			async function loadDisplays() {
				try {
					const displays = await window.electronAPI.recorder.getDisplays();
					displaysGrid.innerHTML = "";

					for (const display of displays) {
						const displayDiv = document.createElement("div");
						displayDiv.className = "display-item";
						displayDiv.onclick = () => selectDisplay(display.id, displayDiv);

						try {
							const thumbnail =
								await window.electronAPI.recorder.getDisplayThumbnail(
									display.id,
									{ maxWidth: 200, maxHeight: 120 }
								);
							displayDiv.innerHTML = `
                            <img src="${thumbnail}" class="thumbnail" alt="Display ${
								display.id
							}">
                            <div><strong>${display.name}</strong></div>
                            <div>${display.width}x${display.height}</div>
                            <div>${
															display.isPrimary ? "üñ•Ô∏è Primary" : "üì± Secondary"
														}</div>
                        `;
						} catch (error) {
							displayDiv.innerHTML = `
                            <div class="thumbnail"></div>
                            <div><strong>${display.name}</strong></div>
                            <div>${display.width}x${display.height}</div>
                            <div>${
															display.isPrimary ? "üñ•Ô∏è Primary" : "üì± Secondary"
														}</div>
                        `;
						}

						displaysGrid.appendChild(displayDiv);
					}

					log(`üì∫ Loaded ${displays.length} displays`);
				} catch (error) {
					log(`‚ùå Error loading displays: ${error.message}`, "error");
					displaysGrid.innerHTML = "<div>Failed to load displays</div>";
				}
			}

			// Load windows
			async function loadWindows() {
				try {
					const windows = await window.electronAPI.recorder.getWindows();
					windowsGrid.innerHTML = "";

					for (const window of windows) {
						const windowDiv = document.createElement("div");
						windowDiv.className = "window-item";
						windowDiv.onclick = () => selectWindow(window.id, windowDiv);

						try {
							const thumbnail =
								await window.electronAPI.recorder.getWindowThumbnail(
									window.id,
									{ maxWidth: 200, maxHeight: 120 }
								);
							windowDiv.innerHTML = `
                            <img src="${thumbnail}" class="thumbnail" alt="${window.name}">
                            <div><strong>${window.name}</strong></div>
                            <div>${window.appName}</div>
                            <div>${window.width}x${window.height}</div>
                        `;
						} catch (error) {
							windowDiv.innerHTML = `
                            <div class="thumbnail"></div>
                            <div><strong>${window.name}</strong></div>
                            <div>${window.appName}</div>
                            <div>${window.width}x${window.height}</div>
                        `;
						}

						windowsGrid.appendChild(windowDiv);
					}

					log(`ü™ü Loaded ${windows.length} windows`);
				} catch (error) {
					log(`‚ùå Error loading windows: ${error.message}`, "error");
					windowsGrid.innerHTML = "<div>Failed to load windows</div>";
				}
			}

			// Check permissions
			async function checkPermissions() {
				try {
					const permissions =
						await window.electronAPI.recorder.checkPermissions();

					permissionsInfo.innerHTML = `
                    <div class="permission-item">
                        <span>Screen Recording:</span>
                        <span class="status-indicator ${
													permissions.screenRecording
														? "status-granted"
														: "status-denied"
												}">
                            ${
															permissions.screenRecording ? "Granted" : "Denied"
														}
                        </span>
                    </div>
                    <div class="permission-item">
                        <span>Accessibility:</span>
                        <span class="status-indicator ${
													permissions.accessibility
														? "status-granted"
														: "status-denied"
												}">
                            ${permissions.accessibility ? "Granted" : "Denied"}
                        </span>
                    </div>
                    <div class="permission-item">
                        <span>Microphone:</span>
                        <span class="status-indicator ${
													permissions.microphone
														? "status-granted"
														: "status-denied"
												}">
                            ${permissions.microphone ? "Granted" : "Denied"}
                        </span>
                    </div>
                `;

					log("üîê Permissions checked");
				} catch (error) {
					log(`‚ùå Error checking permissions: ${error.message}`, "error");
					permissionsInfo.innerHTML = "<div>Failed to check permissions</div>";
				}
			}

			// Select display
			function selectDisplay(displayId, element) {
				// Clear previous selections
				document
					.querySelectorAll(".display-item")
					.forEach((item) => item.classList.remove("selected"));
				document
					.querySelectorAll(".window-item")
					.forEach((item) => item.classList.remove("selected"));

				selectedDisplayId = displayId;
				selectedWindowId = null;
				element.classList.add("selected");
				log(`üì∫ Selected display: ${displayId}`);
			}

			// Select window
			function selectWindow(windowId, element) {
				// Clear previous selections
				document
					.querySelectorAll(".display-item")
					.forEach((item) => item.classList.remove("selected"));
				document
					.querySelectorAll(".window-item")
					.forEach((item) => item.classList.remove("selected"));

				selectedWindowId = windowId;
				selectedDisplayId = null;
				element.classList.add("selected");
				log(`ü™ü Selected window: ${windowId}`);
			}

			// Initialize app
			async function init() {
				try {
					const moduleInfo = await window.electronAPI.recorder.getModuleInfo();
					log(
						`üîå Module initialized: ${moduleInfo.version} (Electron-safe: ${moduleInfo.electronSafe})`
					);

					await loadDisplays();
					await loadWindows();
					await checkPermissions();

					log("‚úÖ Application initialized successfully");
				} catch (error) {
					log(`‚ùå Initialization error: ${error.message}`, "error");
				}
			}

			// Start the app
			init();

			// Cleanup on page unload
			window.addEventListener("beforeunload", () => {
				if (timerInterval) {
					clearInterval(timerInterval);
				}
				window.electronAPI.recorder.removeAllListeners();
			});
		</script>
	</body>
</html>
